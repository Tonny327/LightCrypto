# 🔐 LightCrypto GUI - Полное руководство

> **Графический интерфейс для защищенной передачи данных между двумя компьютерами**

[![Python](https://img.shields.io/badge/Python-3.8+-blue.svg)](https://www.python.org/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)
[![Status](https://img.shields.io/badge/Status-Production-brightgreen.svg)](README_GUI.md)

---

## 📑 Оглавление

1. [Быстрый старт](#-быстрый-старт-5-минут)
2. [Введение](#-введение)
3. [Установка и требования](#-установка-и-требования)
4. [Запуск приложения](#-запуск-приложения)
5. [Интерфейс и навигация](#-интерфейс-и-навигация)
6. [LibSodium режим](#-libsodium-режим)
7. [Custom Codec режим](#-custom-codec-режим)
8. [Продвинутое использование](#-продвинутое-использование)
9. [Устранение проблем](#-устранение-проблем)
10. [FAQ](#-faq)
11. [Техническая информация](#-техническая-информация)

---

## 🚀 Быстрый старт (5 минут)

### Шаг 1: Подготовка (однократно)

```bash
cd /home/tonny/projects/MyCryptoProject/LightCrypto

# 1. Настройка sudo без пароля
sudo ./setup_sudo.sh

# 2. Сборка исполняемых файлов
./rebuild.sh
```

### Шаг 2: Запуск GUI

```bash
cd gui
python3 main.py
```

### Шаг 3: Первое подключение (LibSodium)

**Компьютер A (Отправитель):**
1. Выберите: **🔒 LibSodium** → **📤 Отправитель**
2. Нажмите: **"🔧 Создать TAP-A"**
3. Введите IP компьютера B (например: `192.168.1.100`)
4. Нажмите: **"▶️ ЗАПУСТИТЬ ШИФРОВАНИЕ"**

**Компьютер B (Получатель):**
1. Выберите: **🔒 LibSodium** → **📥 Получатель**
2. Нажмите: **"🔧 Создать TAP-B"**
3. Нажмите: **"▶️ ЗАПУСТИТЬ ШИФРОВАНИЕ"**

**Проверка связи:**
```bash
ping 10.0.0.2  # На компьютере A
```

✅ **Работает!** Весь трафик через tap0/tap1 теперь зашифрован.

---

## 📖 Введение

### Что это?

**LightCrypto GUI** — современный графический интерфейс для системы защищенной передачи данных между двумя компьютерами через виртуальные TAP-интерфейсы.

### Возможности

- ✅ **Два метода шифрования**: LibSodium (промышленный) и Custom Codec (экспериментальный)
- ✅ **Простой интерфейс**: 3 шага до запуска
- ✅ **Встроенный терминал**: полный контроль над процессом
- ✅ **Автосохранение настроек**: все параметры запоминаются
- ✅ **Валидация в реальном времени**: никаких ошибок ввода
- ✅ **Тестовые утилиты**: ping, iperf, hping3 встроены
- ✅ **Режим сообщений**: обмен текстом через терминал

### Два режима шифрования

#### 🔒 **LibSodium** (рекомендуется)
- **Алгоритм**: ChaCha20-Poly1305 AEAD
- **Обмен ключами**: X25519 (ECDH)
- **Аутентификация**: Poly1305 MAC
- **Использование**: Промышленное (Signal, WhatsApp)
- **Скорость**: Очень высокая
- **Надежность**: Проверенная временем

#### ⚡ **Custom Digital Codec** (экспериментальный)
- **Алгоритм**: Цифровое кодирование с нелинейными функциями
- **Ключ**: CSV файл с коэффициентами
- **Аутентификация**: SHA-256 хеш
- **Использование**: Исследовательское
- **Скорость**: Средняя
- **Надежность**: Экспериментальная

---

## 💻 Установка и требования

### Системные требования

- **ОС**: Linux (Ubuntu 20.04+, Debian 10+, Arch, и др.)
- **Python**: 3.8 или выше
- **Права**: sudo доступ
- **Память**: 512 MB RAM
- **Процессор**: Любой современный процессор

### Зависимости

```bash
# Обновление системы
sudo apt update

# Python и Tkinter (обычно уже установлены)
sudo apt install python3 python3-tk

# Инструменты сети (опционально, для тестирования)
sudo apt install iputils-ping iperf hping3 tcpdump
```

### Настройка sudo без пароля (обязательно!)

```bash
cd /home/tonny/projects/MyCryptoProject/LightCrypto
sudo ./setup_sudo.sh
```

Этот скрипт добавит правила в `/etc/sudoers.d/lightcrypto`, разрешающие:
- Запуск `tap_encrypt` и `tap_decrypt` без пароля
- Управление TAP интерфейсами

**Важно**: После выполнения перезапустите терминал!

### Сборка исполняемых файлов

```bash
./rebuild.sh
```

Будут созданы:
- `build/tap_encrypt` — программа отправителя
- `build/tap_decrypt` — программа получателя

### Проверка установки

```bash
# Проверка Python и Tkinter
python3 -c "import tkinter; print('Tkinter OK')"

# Проверка sudo
sudo -n true && echo "sudo OK" || echo "sudo требует настройки"

# Проверка исполняемых файлов
ls -lh build/tap_encrypt build/tap_decrypt
```

Все должно быть OK ✅

---

## 🎯 Запуск приложения

### Основной способ

```bash
cd /home/tonny/projects/MyCryptoProject/LightCrypto/gui
python3 main.py
```

### Альтернативный способ

```bash
# Сделать исполняемым (однократно)
chmod +x main.py

# Запуск
./main.py
```

### Что происходит при запуске?

```
╔═══════════════════════════════════════════════════╗
║           🔐 LightCrypto GUI v1.0.0              ║
║        Система защищенной передачи данных         ║
╚═══════════════════════════════════════════════════╝

🔍 Проверка системных требований...
✅ Sudo доступ: OK
✅ Исполняемые файлы: OK
✅ Проверка завершена
```

После проверки откроется **стартовое окно**.

---

## 🗺️ Интерфейс и навигация

### Трехэтапная навигация

```
     ┌─────────────────────┐
     │  1. Стартовое окно  │
     │  Выбор типа         │
     │  шифрования         │
     └──────────┬──────────┘
                ▼
     ┌─────────────────────┐
     │  2. Выбор роли      │
     │  Encrypt / Decrypt  │
     └──────────┬──────────┘
                ▼
     ┌─────────────────────┐
     │  3. Рабочее окно    │
     │  Полный GUI         │
     └─────────────────────┘
```

---

### Этап 1: Стартовое окно

При запуске вы увидите:

```
╔════════════════════════════════════════════╗
║          🔐 LightCrypto                    ║
║   Система защищенной передачи данных       ║
╠════════════════════════════════════════════╣
║                                            ║
║      Выберите тип шифрования:              ║
║                                            ║
║  ┌──────────────┐   ┌──────────────┐     ║
║  │ 🔒 LibSodium │   │⚡Custom Codec│     ║
║  │              │   │              │     ║
║  │ ChaCha20-    │   │  Digital     │     ║
║  │ Poly1305     │   │  Coding      │     ║
║  │              │   │              │     ║
║  │  [ВЫБРАТЬ]   │   │  [ВЫБРАТЬ]   │     ║
║  └──────────────┘   └──────────────┘     ║
║                                            ║
║  Проверенное              Экспериментальный║
║  криптографическое        алгоритм         ║
║  шифрование                                ║
╚════════════════════════════════════════════╝
```

**Выбор:**
- **🔒 LibSodium** — для надежного шифрования (рекомендуется)
- **⚡ Custom Codec** — для экспериментов с CSV-ключами

---

### Этап 2: Выбор роли

```
╔════════════════════════════════════════════╗
║   Выбранный метод: 🔒 LibSodium            ║
╠════════════════════════════════════════════╣
║                                            ║
║      Выберите роль компьютера:             ║
║                                            ║
║  ┌─────────────┐     ┌─────────────┐     ║
║  │📤Отправитель│     │📥Получатель │     ║
║  │  (Encrypt)  │     │  (Decrypt)  │     ║
║  │             │     │             │     ║
║  │Компьютер A  │     │Компьютер B  │     ║
║  │             │     │             │     ║
║  │ [ВЫБРАТЬ]   │     │ [ВЫБРАТЬ]   │     ║
║  └─────────────┘     └─────────────┘     ║
║                                            ║
║  💡 Подсказка:                             ║
║  Компьютер A (отправитель) инициирует     ║
║  соединение с компьютером B (получатель)  ║
║                                            ║
║             [← Назад]                      ║
╚════════════════════════════════════════════╝
```

**Роли:**
- **📤 Отправитель (Encrypt)** — инициирует соединение
- **📥 Получатель (Decrypt)** — принимает соединение

**Кнопка "← Назад"** — вернуться к выбору типа шифрования

---

### Этап 3: Рабочее окно

Полноценный GUI с панелями:

```
╔═══════════════════════════════════════════════════════╗
║  🔐 LightCrypto - LibSodium Encrypt (Отправитель)    ║
╠═══════════════════════════════════════════════════════╣
║                                                       ║
║  ┌─ 🔧 Управление TAP-интерфейсом ─────────────┐    ║
║  │ [Создать TAP-A] [Очистить TAP]              │    ║
║  │ Статус: 🟢 tap0 активен (10.0.0.1/24)       │    ║
║  └──────────────────────────────────────────────┘    ║
║                                                       ║
║  ┌─ 🌐 Сетевые параметры ───────────────────────┐   ║
║  │ IP-адрес: [192.168.1.100]  Порт: [12345]    │   ║
║  │ ☐ Режим сообщений (--msg)                    │   ║
║  └──────────────────────────────────────────────┘   ║
║                                                       ║
║          [▶️ ЗАПУСТИТЬ ШИФРОВАНИЕ]                   ║
║                                                       ║
║  ┌─ 📋 Терминал ──────────────────────────────┐     ║
║  │ 🚀 Запуск LightCrypto...                    │     ║
║  │ ✅ tap0 создан успешно                       │     ║
║  │ 📡 Ожидание подключения...                  │     ║
║  │                        [🧹 Очистить]         │     ║
║  └──────────────────────────────────────────────┘    ║
║                                                       ║
║  ┌─ 🧪 Генерация тестового трафика ────────────┐    ║
║  │ [🏓 ping] [📊 iperf TCP] [📊 iperf UDP]     │    ║
║  │ [🔄 hping3 SYN] [🔄 hping3 UDP]             │    ║
║  └──────────────────────────────────────────────┘    ║
╚═══════════════════════════════════════════════════════╝
```

---

## 🔒 LibSodium режим

### Архитектура соединения

```
Компьютер A (Encrypt)                Компьютер B (Decrypt)
┌─────────────────┐                  ┌─────────────────┐
│  Приложения     │                  │  Приложения     │
│  (ping, ssh...) │                  │  (сервисы)      │
└────────┬────────┘                  └────────┬────────┘
         │                                    │
┌────────▼────────┐                  ┌────────▼────────┐
│   tap0          │                  │   tap1          │
│   10.0.0.1/24   │                  │   10.0.0.2/24   │
└────────┬────────┘                  └────────┬────────┘
         │                                    │
┌────────▼────────┐                  ┌────────▼────────┐
│  tap_encrypt    │                  │  tap_decrypt    │
│  ChaCha20-Poly  │◄────UDP 12345───►│  ChaCha20-Poly  │
└─────────────────┘                  └─────────────────┘
         │                                    │
   192.168.1.50                         192.168.1.100
   (Физический IP)                      (Физический IP)
```

---

### Компьютер A (Отправитель) — детальная инструкция

#### 1. Создание TAP-интерфейса

**Кнопка**: **"🔧 Создать TAP-A"**

Что происходит:
```bash
# Выполняется скрипт setup_tap_A.sh:
sudo ip tuntap add dev tap0 mode tap
sudo ip addr add 10.0.0.1/24 dev tap0
sudo ip link set tap0 up
```

**Результат в терминале:**
```
🔧 Создание tap0...
✅ tap0 создан успешно!
📡 tap0 активен с адресом 10.0.0.1/24
```

**Индикатор статуса изменится на:**
```
Статус: 🟢 tap0 активен (10.0.0.1/24)
```

**Если ошибка:**
```
❌ Ошибка создания tap0
   Возможно tap0 уже существует
```
→ Нажмите **"🧹 Очистить TAP"** сначала

---

#### 2. Настройка сетевых параметров

**IP-адрес получателя:**
- Введите реальный IP компьютера B в локальной сети
- Примеры: `192.168.1.100`, `10.20.30.40`
- **Важно**: это НЕ IP tap-интерфейса! Это физический IP компьютера B

**Как узнать IP компьютера B:**
```bash
# На компьютере B выполните:
ip addr show | grep "inet " | grep -v "127.0.0.1"
```

**Порт:**
- По умолчанию: `12345`
- Диапазон: 1-65535
- Должен совпадать с портом на компьютере B!

**Режим сообщений:**
- ☐ **Выключен** (по умолчанию):
  - Передается весь Ethernet-трафик через tap0
  - Можно использовать ping, ssh, scp, iperf
  - Работает как VPN
  
- ☑ **Включен**:
  - Передаются только текстовые сообщения
  - Ввод вручную в терминале
  - Полезно для тестирования
  - **Важно**: тестовые утилиты (ping, iperf) будут отключены

---

#### 3. Запуск шифрования

**Кнопка**: **"▶️ ЗАПУСТИТЬ ШИФРОВАНИЕ"**

**Валидация перед запуском:**
- ✅ IP-адрес корректен
- ✅ Порт в диапазоне 1-65535
- ✅ tap0 существует (необязательно, но рекомендуется)

**Команда, которая выполнится:**
```bash
sudo ./build/tap_encrypt [--msg] <IP> <PORT>

# Пример:
sudo ./build/tap_encrypt 192.168.1.100 12345
```

**Вывод в терминале:**
```
🚀 Запуск: sudo ./build/tap_encrypt 192.168.1.100 12345
📡 tap0 открыт для чтения Ethernet-кадров
🌐 Используем IP: 192.168.1.100, порт: 12345
✅ IP-адрес 192.168.1.100 доступен, начинаем работу...

📤 Публичный ключ отправлен получателю
📥 Публичный ключ получен от получателя
✅ Ключи обменены успешно!

🔐 Шифрование активно...
```

**Кнопка изменится на**: **"⏹️ ОСТАНОВИТЬ ШИФРОВАНИЕ"** (красная)

---

#### 4. Тестирование соединения

После успешного запуска доступны кнопки тестирования:

**🏓 ping 10.0.0.2**
- Проверка базовой связности
- Команда: `ping 10.0.0.2`
- Откроется в отдельном терминале

**Пример вывода:**
```
PING 10.0.0.2 (10.0.0.2) 56(84) bytes of data.
64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=2.34 ms
64 bytes from 10.0.0.2: icmp_seq=2 ttl=64 time=1.89 ms
```

**📊 iperf TCP**
- Тест производительности TCP
- Команда: `iperf -c 10.0.0.2 -t 10`
- **Требуется**: iperf сервер на компьютере B

**📊 iperf UDP**
- Тест производительности UDP
- Команда: `iperf -c 10.0.0.2 -u -t 10 -b 100M`
- Отправка UDP пакетов со скоростью до 100 Мбит/с

**🔄 hping3 SYN**
- Отправка TCP SYN пакетов
- Команда: `hping3 10.0.0.2 -S -p 80 -c 10`
- Полезно для тестирования firewall

**🔄 hping3 UDP**
- Отправка UDP пакетов
- Команда: `hping3 10.0.0.2 -2 -p 5000 -c 10`

**Важно**: Все эти утилиты отключены если включен **"Режим сообщений"**!

---

### Компьютер B (Получатель) — детальная инструкция

#### 1. Создание TAP-интерфейса

**Кнопка**: **"🔧 Создать TAP-B"**

Создается `tap1` с IP `10.0.0.2/24`

**Результат:**
```
Статус: 🟢 tap1 активен (10.0.0.2/24)
```

---

#### 2. Настройка сетевых параметров

**IP прослушивания:**
- По умолчанию: `0.0.0.0` (слушать на всех интерфейсах)
- Можно оставить как есть
- Или указать конкретный IP если нужно

**Порт:**
- **Должен совпадать** с портом на компьютере A!
- По умолчанию: `12345`

**Режим сообщений:**
- **Должен совпадать** с компьютером A!
- Если на A включен → на B тоже включите
- Если на A выключен → на B тоже выключите

---

#### 3. Запуск шифрования

**Кнопка**: **"▶️ ЗАПУСТИТЬ ШИФРОВАНИЕ"**

**Команда:**
```bash
sudo ./build/tap_decrypt [--msg] <PORT>

# Пример:
sudo ./build/tap_decrypt 12345
```

**Вывод в терминале:**
```
🚀 Запуск: sudo ./build/tap_decrypt 12345
📡 tap1 открыт для записи расшифрованных Ethernet-кадров
🌐 Ожидаем пакеты на IP: 0.0.0.0, порт: 12345
✅ bind() выполнен успешно

📥 Ожидание подключения от отправителя...
📥 Публичный ключ отправителя получен
📤 Отправлен свой публичный ключ
✅ Ключи обменены успешно!

🔐 Расшифровка активна...
✅ Принят и расшифрован кадр (98 байт)
✅ Хеши совпадают — кадр корректен
```

---

#### 4. Запуск сервисов для тестирования

**🛰️ iperf TCP сервер**
- Команда: `iperf -s -B 10.0.0.2`
- Слушает TCP на порту 5001
- Откроется в отдельном терминале
- Используется для теста с компьютера A

**🛰️ iperf UDP сервер**
- Команда: `iperf -s -u -B 10.0.0.2`
- Слушает UDP на порту 5001

**🔍 tcpdump tap1**
- Команда: `sudo tcpdump -i tap1 -v`
- Мониторинг всего трафика на tap1
- Полезно для отладки

**Пример вывода tcpdump:**
```
listening on tap1, link-type EN10MB
12:34:56.123456 IP 10.0.0.1 > 10.0.0.2: ICMP echo request
12:34:56.123789 IP 10.0.0.2 > 10.0.0.1: ICMP echo reply
```

---

### Режим сообщений (--msg)

Специальный режим для обмена текстовыми сообщениями.

#### Включение

Поставьте галочку: **☑ Режим сообщений (--msg)**

#### Работа с сообщениями

**Компьютер A (Отправитель):**

После запуска в терминале появится:
```
💬 Режим отправки сообщений. Вводите текст:
> _
```

Введите сообщение и нажмите Enter:
```
> Привет, как дела?
📤 Сообщение отправлено (30 байт)

> Тестирую шифрование
📤 Сообщение отправлено (38 байт)
```

**Компьютер B (Получатель):**

Сообщения появятся в терминале:
```
📩 Получено сообщение (30 байт): Привет, как дела?
✅ Хеш проверен — сообщение корректно

📩 Получено сообщение (38 байт): Тестирую шифрование
✅ Хеш проверен — сообщение корректно
```

#### Важные замечания

- ⚠️ В режиме сообщений **отключены** все тестовые утилиты
- ✅ Сообщения защищены SHA-256 хешем
- ✅ Любое повреждение данных будет обнаружено
- ⚠️ Весь трафик tap0/tap1 игнорируется, только текст

---

## ⚡ Custom Codec режим

Custom Codec — экспериментальный алгоритм цифрового кодирования на основе нелинейных функций.

### Ключевое отличие от LibSodium

| Параметр | LibSodium | Custom Codec |
|----------|-----------|--------------|
| Ключ | Обмен автоматически (X25519) | CSV файл с коэффициентами |
| Настройка | Минимальная | Требуется настройка параметров |
| Параметры | Нет | M, Q, funType, h1, h2 |
| Сложность | Простая | Средняя |

### Панель параметров кодека

При выборе Custom Codec появляется **дополнительная панель** сверху:

```
╔═ ⚙️ Параметры цифрового кодека ═══════════════════╗
║                                                    ║
║ ┌─ Файл ключа (CSV) ──────────────────────────┐  ║
║ │ [Q=2_4.csv ▼]  [📁 Обзор]  [🔄 Обновить]   │  ║
║ │                                              │  ║
║ │ 💡 Авто-определено: 4 строки (Q=2),         │  ║
║ │    3 столбца (функции 1-4)                  │  ║
║ │    Рекомендуемые параметры: M=8, Q=2, fun=1 │  ║
║ └──────────────────────────────────────────────┘  ║
║                                                    ║
║ ┌─ Параметры алгоритма ────────────────────────┐  ║
║ │ M (разрядность):  [8] ▲▼  ℹ️                │  ║
║ │ Q (информ. биты): [2] ▲▼  ☑️ Авто из CSV    │  ║
║ │                                              │  ║
║ │ Тип функции: [1: a*x + b*y + q ▼]           │  ║
║ │                                              │  ║
║ │ Начальные состояния:                         │  ║
║ │   h1: [7] ▲▼    h2: [23] ▲▼  [🎲 Случайно] │  ║
║ └──────────────────────────────────────────────┘  ║
║                                                    ║
║ ┌─ Управление профилями ───────────────────────┐  ║
║ │ [💾 Сохранить]  [📂 Загрузить]              │  ║
║ │ [🔄 Сброс]      [📋 Копировать команду]     │  ║
║ └──────────────────────────────────────────────┘  ║
║                                                    ║
║ ┌─ Статус конфигурации ────────────────────────┐  ║
║ │ ✅ CSV выбран: Q=2_4.csv                     │  ║
║ │ ✅ Параметры валидны (M≥Q, строк=2^Q)       │  ║
║ │ ✅ Готов к запуску                           │  ║
║ └──────────────────────────────────────────────┘  ║
╚════════════════════════════════════════════════════╝
```

---

### Выбор CSV-ключа

#### Автосканирование

При открытии GUI автоматически сканируется папка `CipherKeys/`:

```
CipherKeys/
├── N_16_6_primes.csv
├── N_16_7.csv
├── Q=2_2.csv
├── Q=2_3.csv
├── Q=2_4.csv          ← Рекомендуется для начала
├── Q=2_5.csv
├── Q=2_6.csv
├── Q=2_7.csv
├── Q=2_8.csv
├── Q=4.csv
├── QDM-6.csv
└── ...
```

#### Выбор из списка

Откройте выпадающий список и выберите CSV файл.

**Рекомендуемые для начала:**
- `Q=2_4.csv` — простой (4 функции)
- `Q=2_6.csv` — средний (4 функции)
- `Q=4.csv` — сложнее (16 функций)
- `QDM-6.csv` — продвинутый (64 функции)

#### Кнопка "📁 Обзор"

Открывает файловый диалог для выбора CSV вне стандартной папки.

#### Кнопка "🔄 Обновить"

Пересканирует папку `CipherKeys/` (если добавили новые файлы во время работы).

---

### Автоанализ CSV

При выборе CSV файл автоматически анализируется:

```python
# Система считает:
rows = количество_строк_в_CSV
cols = количество_столбцов
Q = log₂(rows)  # Автоматически!
```

**Пример для `Q=2_4.csv`:**
```
Строк: 4
Q = log₂(4) = 2  ✅
Столбцов: 3
→ Доступны функции 1-4
```

**Информационная подсказка покажет:**
```
💡 Авто-определено: 4 строки (Q=2), 3 столбца (функции 1-4)
   Рекомендуемые параметры: M=8, Q=2, fun=1
```

---

### Параметры алгоритма

#### M (разрядность вычислителя)

**Диапазон**: 1-31  
**По умолчанию**: 8  
**Рекомендуется**: M ≥ Q

**Что это:**
- Разрядность внутренних вычислений в битах
- Определяет диапазон значений: `[-2^(M-1), 2^(M-1)-1]`
- Пример для M=8: диапазон [-128, 127]

**Подсказка (ℹ️):**
```
M — разрядность вычислителя в битах (1..31)

Определяет диапазон значений: [-2^(M-1), 2^(M-1)-1]

Пример для M=8: Диапазон [-128, 127]

Требование: M ≥ Q
Рекомендация: M = 8 для байтовых данных
```

---

#### Q (информационные биты на символ)

**Диапазон**: 1-16  
**По умолчанию**: 2  
**Определяется**: Автоматически из CSV

**Что это:**
- Количество информационных бит на один символ
- Определяет количество функций: 2^Q
- Пример для Q=2: 4 функции (2^2 = 4)

**Чекбокс "☑ Авто из CSV":**
- **Включен** (рекомендуется): Q берется из CSV автоматически
- **Выключен**: можно установить Q вручную (для экспериментов)

**Валидация:**
```
✅ Совместимо: CSV содержит 4 строки (2^2 = 4)
```
или
```
❌ Несовпадение: CSV содержит 8 строк, ожидается 4 для Q=2
   Выберите Q=3 или другой CSV файл
```

---

#### Тип функции (funType)

Выбор математической функции кодирования:

**5 типов функций:**

1. **`1: a·x + b·y + q`** (линейная) — самая быстрая
2. **`2: a·x² + b·y + q`** (квадратичная по x)
3. **`3: a·x² + b·y² + q`** (квадратичная)
4. **`4: a·x³ + b·y² + q`** (кубическая по x)
5. **`5: a·x + b·x·y + c·y + q`** (билинейная) — требует 4 столбца в CSV

**Автоопределение доступности:**
- CSV с 3 столбцами → доступны функции 1-4
- CSV с 4 столбцами → доступна только функция 5

**Недоступные функции** будут помечены серым:
```
[Недоступно] 5: a·x + b·x·y + c·y + q
```

---

#### Начальные состояния (h1, h2)

**Диапазон**: от -2147483648 до 2147483647 (int32)  
**По умолчанию**: h1=7, h2=23  
**Рекомендуется**: небольшие значения (0-100)

**Что это:**
- Начальные состояния внутреннего шифратора
- Влияют на первые два шага кодирования
- **КРИТИЧЕСКИ ВАЖНО**: должны совпадать на обоих компьютерах!

**Кнопка "🎲 Случайно":**
- Генерирует случайные значения (0-100)
- Полезно для создания уникальных конфигураций
- **Не забудьте** передать значения напарнику!

**Подсказка (ℹ️):**
```
h1, h2 — начальные состояния шифратора

Влияют на первые два шага алгоритма кодирования.

ВАЖНО:
Значения h1 и h2 ДОЛЖНЫ быть идентичны
на компьютере отправителя и получателя!

Рекомендуется использовать небольшие числа
для упрощения отладки (например, 0-100).
```

---

### Валидация параметров (Статус-блок)

Блок в нижней части панели показывает статус конфигурации в реальном времени.

#### ✅ Зеленый статус (все корректно):

```
┌─ Статус конфигурации ────────────────────────┐
│ ✅ CSV выбран: Q=2_4.csv                     │
│ ✅ Параметры валидны (M≥Q, строк=2^Q)       │
│ ✅ Готов к запуску                           │
└──────────────────────────────────────────────┘
```

**Можно запускать!**

---

#### ⚠️ Желтый статус (предупреждения):

```
┌─ Статус конфигурации ────────────────────────┐
│ ⚠️ M=2 меньше рекомендуемого значения (8)   │
│ ⚠️ h1 и h2 имеют одинаковые значения        │
│ ℹ️ Работать будет, но безопасность снижена  │
└──────────────────────────────────────────────┘
```

**Можно запускать, но с осторожностью!**

---

#### ❌ Красный статус (критические ошибки):

```
┌─ Статус конфигурации ────────────────────────┐
│ ❌ CSV не выбран                             │
│ ❌ M < Q: увеличьте M до минимум 4          │
│ ❌ CSV несовместим: 8 строк, ожидается 4    │
│ 🚫 Запуск заблокирован                       │
└──────────────────────────────────────────────┘
```

**Запуск невозможен! Исправьте ошибки.**

---

### Управление профилями

#### 💾 Сохранить профиль

Сохраняет текущие параметры в JSON файл:

```json
{
  "name": "Тестовый профиль Q=2",
  "csv_file": "Q=2_4.csv",
  "M": 8,
  "Q": 2,
  "funType": 1,
  "h1": 7,
  "h2": 23,
  "timestamp": "2025-10-12 15:30:00"
}
```

**Где сохраняется:**
```
~/.config/lightcrypto/profiles/custom_codec/<имя>.json
```

**Использование:**
1. Нажмите "💾 Сохранить"
2. Введите имя профиля (например, "test_q2")
3. Готово! Профиль сохранен

---

#### 📂 Загрузить профиль

Загружает ранее сохраненный профиль:

1. Нажмите "📂 Загрузить"
2. Увидите список: `test_q2, production, experiment`
3. Введите имя профиля
4. Все параметры загрузятся автоматически!

---

#### 🔄 Сброс к умолчанию

Сбрасывает все параметры:
- M = 8
- Q = 2
- funType = 1
- h1 = 7
- h2 = 23
- CSV = (не выбран)

---

#### 📋 Копировать команду

**Самая полезная кнопка для синхронизации!**

Копирует параметры в буфер обмена:

```
--codec CipherKeys/Q=2_4.csv --M 8 --Q 2 --fun 1 --h1 7 --h2 23
```

**Сценарий использования:**

**Компьютер A:**
1. Настройте параметры
2. Нажмите "📋 Копировать команду"
3. Отправьте строку напарнику через Telegram/WhatsApp/Email

**Компьютер B:**
1. Получите строку от напарника
2. Вручную установите те же параметры в GUI:
   - Выберите тот же CSV
   - Установите те же M, Q, fun, h1, h2
3. Готово! Параметры синхронизированы

---

### Запуск Custom Codec

После настройки параметров остальные шаги **идентичны LibSodium**:

1. Создайте TAP (A или B)
2. Настройте IP и порт
3. Нажмите "Запустить шифрование"

**Команда для Encrypt:**
```bash
sudo ./build/tap_encrypt \
  --codec CipherKeys/Q=2_4.csv \
  --M 8 --Q 2 --fun 1 \
  --h1 7 --h2 23 \
  [--msg] \
  192.168.1.100 12345
```

**Команда для Decrypt:**
```bash
sudo ./build/tap_decrypt \
  --codec CipherKeys/Q=2_4.csv \
  --M 8 --Q 2 --fun 1 \
  --h1 7 --h2 23 \
  [--msg] \
  12345
```

---

## 🎓 Продвинутое использование

### Передача файлов через зашифрованное соединение

После установки соединения можно передавать файлы через `scp`:

```bash
# На компьютере A:
scp large_file.zip user@10.0.0.2:/home/user/

# Или используя rsync:
rsync -avz --progress folder/ user@10.0.0.2:/backup/
```

Файлы будут переданы **зашифрованными** через TAP!

---

### SSH через зашифрованный канал

```bash
# На компьютере A подключитесь к B:
ssh user@10.0.0.2

# Все данные SSH + данные зашифрованы дважды:
# 1. SSH шифрование
# 2. LightCrypto шифрование
```

---

### Постоянный маршрут

Добавьте маршруты для автоматического использования TAP:

```bash
# На компьютере A:
sudo ip route add 10.0.0.0/24 dev tap0

# На компьютере B:
sudo ip route add 10.0.0.0/24 dev tap1
```

---

### Автозапуск при загрузке (systemd)

Создайте systemd unit файлы для автозапуска:

```bash
# /etc/systemd/system/lightcrypto-encrypt.service
[Unit]
Description=LightCrypto Encrypt
After=network.target

[Service]
Type=simple
User=root
ExecStart=/home/tonny/projects/MyCryptoProject/LightCrypto/build/tap_encrypt 192.168.1.100 12345
Restart=always

[Install]
WantedBy=multi-user.target
```

Активация:
```bash
sudo systemctl enable lightcrypto-encrypt
sudo systemctl start lightcrypto-encrypt
```

---

## 🔧 Устранение проблем

### Ошибка: "sudo requires password"

**Причина:** sudo не настроен для работы без пароля

**Решение:**
```bash
sudo ./setup_sudo.sh
# Перезапустите терминал
```

**Проверка:**
```bash
sudo -n true && echo "OK" || echo "Нужен пароль"
```

---

### Ошибка: "tap_encrypt not found"

**Причина:** Исполняемые файлы не собраны

**Решение:**
```bash
./rebuild.sh
```

**Проверка:**
```bash
ls -lh build/tap_encrypt build/tap_decrypt
```

Должно быть:
```
-rwxr-xr-x 1 user user 2.1M ... build/tap_encrypt
-rwxr-xr-x 1 user user 2.0M ... build/tap_decrypt
```

---

### TAP интерфейс не создается

**Ошибка:**
```
❌ Ошибка создания tap0
RTNETLINK answers: Operation not permitted
```

**Причина:** Недостаточно прав или TAP уже существует

**Решение 1 — Проверка sudo:**
```bash
sudo -n ip link show && echo "sudo OK"
```

**Решение 2 — Удаление существующего TAP:**
```bash
sudo ip link delete tap0
# или через GUI: кнопка "Очистить TAP"
```

**Решение 3 — Ручное создание:**
```bash
sudo bash setup_tap_A.sh  # для компьютера A
sudo bash setup_tap_B.sh  # для компьютера B
```

---

### IP-адрес недоступен (ping failed)

**Ошибка в терминале:**
```
⚠️ Внимание: IP-адрес 192.168.1.100 недоступен (ping не прошёл)
```

**Проверка сети:**
```bash
# Проверьте доступность компьютера B:
ping 192.168.1.100

# Проверьте что оба в одной сети:
ip route show
```

**Возможные причины:**
1. Компьютер B выключен
2. Firewall блокирует ICMP (ping)
3. Разные сети (нет маршрута)

**Решение:**
- Убедитесь что компьютер B включен и в сети
- Временно отключите firewall для теста:
  ```bash
  sudo ufw disable  # Ubuntu
  sudo systemctl stop firewalld  # CentOS
  ```

---

### Хеш не совпадает (Custom Codec)

**Ошибка:**
```
⚠️ Хеш не совпадает в decodeMessage — данные могут быть повреждены!
⚠️ Выводим данные для отладки (возможно искажены):
```

**Причина:** Параметры кодека не совпадают между компьютерами!

**Проверьте:**
```
Компьютер A          Компьютер B
CSV: Q=2_4.csv   ≟   CSV: Q=2_4.csv   ✅
M: 8             ≟   M: 8             ✅
Q: 2             ≟   Q: 2             ✅
fun: 1           ≟   fun: 1           ✅
h1: 7            ≟   h1: 7            ✅
h2: 23           ≟   h2: 23           ✅
--msg: да        ≟   --msg: да        ✅
```

**Все параметры ДОЛЖНЫ совпадать!**

**Решение:**
1. На компьютере A нажмите "📋 Копировать команду"
2. Отправьте параметры компьютеру B
3. На компьютере B установите те же значения
4. Перезапустите оба приложения

---

### Процесс не останавливается

**Проблема:** Кнопка "Остановить" не работает или зависает

**Решение 1 — Принудительная остановка через GUI:**
Закройте окно → появится диалог подтверждения → выберите "Да"

**Решение 2 — Остановка через терминал:**
```bash
# Найдите процессы:
ps aux | grep tap_encrypt
ps aux | grep tap_decrypt

# Остановите:
sudo killall tap_encrypt
sudo killall tap_decrypt
```

**Решение 3 — Жесткая остановка:**
```bash
sudo pkill -9 tap_encrypt
sudo pkill -9 tap_decrypt
```

---

### Терминал не показывает вывод

**Проблема:** Окно терминала пустое, нет вывода процесса

**Причина:** xterm недоступен или ошибка PTY

**Решение:**
```bash
# Проверка xterm:
which xterm
echo $DISPLAY

# Установка xterm:
sudo apt install xterm
```

**Альтернатива:**  
GUI использует резервный режим (ScrolledText) если xterm недоступен.

---

### Ошибка: "CSV rows != 2^Q"

**Ошибка при выборе CSV:**
```
❌ CSV ошибка: Количество строк (5) не является степенью 2
```

**Причина:** CSV файл некорректен

**Решение:**
- Выберите другой CSV файл
- Проверьте корректность файла:
  ```bash
  wc -l CipherKeys/Q=2_4.csv  # Должно быть 4 строки для Q=2
  ```

---

## ❓ FAQ

### В чем разница между LibSodium и Custom Codec?

| Характеристика | LibSodium | Custom Codec |
|----------------|-----------|--------------|
| **Алгоритм** | ChaCha20-Poly1305 | Цифровое кодирование |
| **Безопасность** | Промышленный стандарт | Экспериментальный |
| **Сложность настройки** | Простая | Средняя |
| **Ключ** | Автоматический обмен | CSV файл |
| **Параметры** | Нет | M, Q, funType, h1, h2 |
| **Скорость** | Очень высокая | Средняя |
| **Использование** | Для продакшена | Для исследований |

**Рекомендация:** Начните с LibSodium!

---

### Нужны ли два компьютера или можно на одном?

**Для продакшена:** Нужны **два физических компьютера** в локальной сети.

**Для тестирования:** Можно запустить **оба GUI на одном компьютере**:
- Терминал 1: Decrypt (получатель)
- Терминал 2: Encrypt (отправитель) с IP `127.0.0.1`

Это полезно для быстрого тестирования и отладки.

---

### Как работает обмен ключами в LibSodium?

```
1. Компьютер A запускается первым:
   - Генерирует пару ключей X25519: (public_A, private_A)
   - Отправляет public_A на компьютер B через UDP

2. Компьютер B получает public_A:
   - Генерирует свою пару: (public_B, private_B)
   - Отправляет public_B обратно компьютеру A
   - Вычисляет общий секрет: shared = kx(public_A, private_B)
   - Генерирует ключи шифрования: rx_key, tx_key

3. Компьютер A получает public_B:
   - Вычисляет тот же общий секрет: shared = kx(public_B, private_A)
   - Генерирует те же ключи: rx_key, tx_key

4. Готово! Оба компьютера имеют одинаковые ключи шифрования
```

**Безопасность:** Даже если кто-то перехватит public_A и public_B, он не сможет вычислить shared секрет без private ключей!

---

### Можно ли использовать для VPN?

**Да!** LightCrypto работает как VPN на канальном уровне (Layer 2).

После установки соединения:
```bash
# Можно использовать любые TCP/UDP приложения:
ping 10.0.0.2
ssh user@10.0.0.2
scp file.txt user@10.0.0.2:/tmp/
curl http://10.0.0.2:8080
```

Весь трафик автоматически шифруется!

---

### Как передавать файлы?

**Через scp:**
```bash
scp file.txt user@10.0.0.2:/home/user/
```

**Через rsync:**
```bash
rsync -avz folder/ user@10.0.0.2:/backup/
```

**Через HTTP:**
```bash
# На компьютере B запустите простой HTTP сервер:
cd /path/to/files
python3 -m http.server 8080 --bind 10.0.0.2

# На компьютере A скачайте:
wget http://10.0.0.2:8080/file.txt
```

---

### Какой CSV выбрать для Custom Codec?

**Для начала:**
- `Q=2_4.csv` — самый простой (4 функции)
- `Q=2_6.csv` — средний (4 функции)

**Для экспериментов:**
- `Q=4.csv` — 16 функций
- `QDM-6.csv` — 64 функции (Q=6)

**Правило:** Чем больше Q, тем:
- ✅ Больше безопасность (больше функций)
- ❌ Медленнее работа (перебор функций при декодировании)

---

### Режим кадров vs режим сообщений?

**Режим кадров (без --msg):**
- Передается весь Ethernet-трафик tap0/tap1
- Работает как VPN
- Можно использовать ping, ssh, http, и т.д.
- **Для продакшена**

**Режим сообщений (с --msg):**
- Передаются только текстовые строки
- Ввод вручную в терминале
- Полезно для тестирования
- **Для отладки**

---

### Безопасно ли использовать Custom Codec?

**LibSodium:** ✅ Абсолютно безопасно (промышленный стандарт)

**Custom Codec:** ⚠️ Экспериментальный

Custom Codec:
- ✅ Использует SHA-256 для проверки целостности
- ✅ Нелинейные функции усложняют криптоанализ
- ⚠️ Не прошел независимый аудит
- ⚠️ Медленнее чем LibSodium

**Рекомендация:**
- Для реальной защиты данных используйте **LibSodium**
- Custom Codec — для исследований и экспериментов

---

## 🔬 Техническая информация

### Архитектура приложения

```
main.py (Точка входа)
   ↓
launcher.py (Выбор типа шифрования)
   ↓
role_selector.py (Выбор роли)
   ↓
   ├─→ libsodium/encrypt_window.py
   ├─→ libsodium/decrypt_window.py
   ├─→ custom/encrypt_window.py (с codec_panel)
   └─→ custom/decrypt_window.py (с codec_panel)
```

### Модульная структура

```
gui/
├── main.py                  # Координация, проверка системы
├── launcher.py              # Стартовое окно
├── role_selector.py         # Выбор роли
│
├── common/                  # Переиспользуемые компоненты
│   ├── constants.py         # Константы (цвета, пути, размеры)
│   ├── utils.py             # Утилиты (валидация, CSV анализ)
│   ├── config.py            # ConfigManager (автосохранение)
│   └── terminal.py          # EmbeddedTerminal (xterm + PTY)
│
├── libsodium/               # LibSodium GUI
│   ├── encrypt_window.py    # Окно отправителя
│   └── decrypt_window.py    # Окно получателя
│
└── custom/                  # Custom Codec GUI
    ├── codec_panel.py       # Панель параметров (переиспользуемая)
    ├── encrypt_window.py    # Окно отправителя с кодеком
    └── decrypt_window.py    # Окно получателя с кодеком
```

### Статистика

- **Файлов Python:** 17
- **Строк кода:** ~5800
- **Модулей:** 4 (main, common, libsodium, custom)
- **Классов GUI:** 8

### Встроенный терминал

**Двухпанельная структура:**
- **Верхняя панель:** xterm (если доступен) для интерактивного ввода
- **Нижняя панель:** ScrolledText для вывода логов

**Захват вывода:**
- Через PTY (pseudo-terminal) для полного захвата
- Поддержка ANSI escape sequences
- Автопрокрутка к последней строке
- Буфер: 10000 строк (старые автоматически удаляются)

### Автосохранение

**Файл конфигурации:**
```
~/.config/lightcrypto/gui_config.json
```

**Сохраняются:**
- IP-адреса (последние использованные)
- Порты
- Режим сообщений
- Custom Codec: CSV, M, Q, funType, h1, h2
- Геометрия окон

**Загрузка:** Автоматически при следующем запуске

### Валидация

**В реальном времени:**
- IP-адреса (регулярные выражения)
- Порты (1-65535)
- Параметры кодека (M≥Q, строк=2^Q)
- CSV файлы (анализ структуры)

**Цветовые индикаторы:**
- 🟢 Зеленый — все OK
- 🟡 Желтый — предупреждения
- 🔴 Красный — ошибки (запуск блокирован)

---

## 📝 Заключение

**LightCrypto GUI** — мощный и удобный инструмент для защищенной передачи данных.

**Начните с LibSodium** для простого и надежного шифрования.

**Попробуйте Custom Codec** для экспериментов с цифровым кодированием.

---

**Версия:** 1.0.0  
**Дата:** 2025-10-12  
**Автор:** LightCrypto Team  
**Лицензия:** MIT

---

## 🔗 Дополнительные ресурсы

- **TESTING_TWO_DEVICES.md** — продвинутые сценарии тестирования
- **CODEC_HOWTO.md** — детали цифрового кодека
- **Исходный код:** `/gui/` директория

---

**Удачного шифрования! 🔐**
