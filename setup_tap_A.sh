#!/bin/bash
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ tap0 –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ A (–ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ tap_encrypt)

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
TAP_A_IP="${1:-10.0.0.1/24}"

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ tap0 –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ A..."
echo "   IP –∞–¥—Ä–µ—Å: $TAP_A_IP"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ tap0 —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if ! ip link show tap0 &>/dev/null; then
    echo "‚ùå –û—à–∏–±–∫–∞: tap0 –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
    echo "   –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: sudo ./build/tap_encrypt <IP_–∫–æ–º–ø—å—é—Ç–µ—Ä–∞_B> 12345"
    exit 1
fi

echo "‚úÖ tap0 –Ω–∞–π–¥–µ–Ω"

# –û—Ç–∫–ª—é—á–∞–µ–º IPv6 (—á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª)
echo "  ‚Üí –û—Ç–∫–ª—é—á–µ–Ω–∏–µ IPv6 –Ω–∞ tap0..."
sudo sysctl -w net.ipv6.conf.tap0.disable_ipv6=1 >/dev/null 2>&1

# –ü–æ–¥–Ω–∏–º–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
echo "  ‚Üí –ü–æ–¥–Ω—è—Ç–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ tap0..."
sudo ip link set tap0 up

# –ù–∞–∑–Ω–∞—á–∞–µ–º IP-–∞–¥—Ä–µ—Å
echo "  ‚Üí –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ IP-–∞–¥—Ä–µ—Å–∞ $TAP_A_IP..."
sudo ip addr add $TAP_A_IP dev tap0 2>/dev/null

echo ""
echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìä –°—Ç–∞—Ç—É—Å tap0:"
ip addr show tap0

echo ""
echo "üß™ –ú–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å ping:"
echo "   ping 10.0.0.2 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é))"

