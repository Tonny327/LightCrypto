#!/bin/bash
# –°–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ tap1 –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ B

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
TAP_B_IP="${1:-10.0.0.2/24}"

echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ tap1 –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ B..."
echo "   IP –∞–¥—Ä–µ—Å: $TAP_B_IP"

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if ip link show tap1 &>/dev/null; then
    echo "  ‚Üí –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ tap1..."
    sudo ip link delete tap1 2>/dev/null || true
fi

# –°–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
echo "  ‚Üí –°–æ–∑–¥–∞–Ω–∏–µ tap1..."
sudo ip tuntap add dev tap1 mode tap user $USER
if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è tap1!"
    exit 1
fi

echo "‚úÖ tap1 —Å–æ–∑–¥–∞–Ω"

# –û—Ç–∫–ª—é—á–∞–µ–º IPv6 (—á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª)
echo "  ‚Üí –û—Ç–∫–ª—é—á–µ–Ω–∏–µ IPv6 –Ω–∞ tap1..."
sudo sysctl -w net.ipv6.conf.tap1.disable_ipv6=1 >/dev/null 2>&1

# –ü–æ–¥–Ω–∏–º–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
echo "  ‚Üí –ü–æ–¥–Ω—è—Ç–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ tap1..."
sudo ip link set tap1 up

# –ù–∞–∑–Ω–∞—á–∞–µ–º IP-–∞–¥—Ä–µ—Å
echo "  ‚Üí –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ IP-–∞–¥—Ä–µ—Å–∞ $TAP_B_IP..."
sudo ip addr add $TAP_B_IP dev tap1 2>/dev/null

echo ""
echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìä –°—Ç–∞—Ç—É—Å tap1:"
ip addr show tap1

echo ""
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ A..."

